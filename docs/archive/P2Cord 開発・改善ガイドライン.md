# **P2Cord 開発・改善ガイドライン**

本ドキュメントは、チャンネル切り替えのレスポンス向上と、P2P共有機能とDiscordクライアントの完全な統合を実現するための設計指針をまとめたものです。

## **1\. ユーザー体験（UX）の改善：レスポンスの最大化**

チャンネル切り替え時の「一息つくような遅延」を解消し、Discord本家を超えるキレのある操作感を目指します。

### **1.1 同期的スクロール制御**

Reactの useLayoutEffect を活用し、ブラウザが画面を描画する（Paint）前にスクロール位置を確定させます。

* **手法**: requestAnimationFrame や behavior: 'smooth' を排除し、container.scrollTop \= container.scrollHeight で直接代入します。  
* **効果**: 画面が表示された瞬間には、すでに最新メッセージの位置に移動している状態になります。

### **1.2 視覚的連続性の確保**

真っ黒なオーバーレイ（Iron Curtain）を廃止し、visibility 属性による制御に切り替えます。

* **手法**: isSwitchingChannel が true の間、チャットエリアを visibility: hidden にします。  
* **効果**: サイドバーなどのUIは維持されたまま、メッセージの「ジャンプ」だけを隠すことができ、ロード中というネガティブな印象を払拭します。

### **1.3 レイアウトシフトの防止**

画像の高さが未確定なことによるスクロール位置のズレを防止します。

* **手法**: DiscordAttachment の width/height を活用し、img タグにアスペクト比またはサイズを明示します。  
* **効果**: 画像読み込み完了によるガクつきがなくなり、一発でスクロール位置が安定します。

## **2\. アーキテクチャの再定義：P2Cord への昇華**

「機能の継ぎ足し」から「プラットフォーム」への移行。Discordはあくまで「メタデータ（名簿や部屋）」として扱い、通信の実体はP2Pが担う設計です。

### **2.1 抽象化概念：Room**

Discordの各チャンネルを、アプリ内では **「Room（部屋）」** という単位に抽象化します。

* **Roomの内容**:  
  * **Social**: Discordのメッセージ履歴、チャンネル名。  
  * **Media**: その部屋で展開されているP2Pセッション（画面共有、ボイス）。  
  * **Context**: 参加しているピア（Peer）の接続状態。

### **2.2 バックエンド（Rust）の責務分離**

src-tauri/src/lib.rs に集中しているロジックを、サービス単位に分割します。

* **Identity**: 認証と自分の情報。  
* **Social**: サーバー一覧、チャンネル、メッセージ（Discord API/Gateway）。  
* **Media**: P2Pの確立、エンコード、WebRTC制御（P2Dコア）。  
* **Bridge**: Tauriのコマンドを受け取り、上記サービスを連携させるコントローラー。

### **2.3 フロントエンドのステート管理**

App.tsx の巨大なStateを分割し、Zustand等のストアを導入します。

* **Storeの役割**: 「現在どのサーバーのどの部屋にいるか」「どのメディアに接続中か」をグローバルに管理し、UIコンポーネントはそれを参照するだけの薄い存在にします。

## **3\. ボイス・メディア統合戦略**

### **3.1 P2P-First ボイスチャット**

Discordのボイスサーバー（RTC）を使用せず、DiscordのチャンネルIDをキーにしてユーザー同士をP2Pで直接繋ぎます。

* **フロー**:  
  1. ユーザーがボイスチャンネルをクリック。  
  2. Discord Gatewayへ入室通知（プレゼンス反映）。  
  3. 同じチャンネルにいるユーザーのP2P IDを特定。  
  4. WebRTCでOffer/Answerを交換し、音声を直接送受信。  
* **利点**: Discordのサーバー負荷を回避し、超低遅延・高音質な通話を実現。

### **3.2 統一された入室コマンド**

invoke('join\_room') というひとつのコマンドで、以下の処理を並列に開始します。

1. キャッシュからメッセージを即時表示。  
2. Discord APIから最新メッセージを取得。  
3. P2Pシグナリングを開始し、メディアセッションの準備。

## **4\. 今後のロードマップ**

1. **Phase 1 (Performance)**: useLayoutEffect と visibility によるレスポンス改善の適用。  
2. **Phase 2 (Refactoring)**: Rust側 Service層の分離と、フロントエンドのストア導入。  
3. **Phase 3 (Integration)**: DiscordチャンネルIDをベースにしたP2Pボイスチャットの統合。