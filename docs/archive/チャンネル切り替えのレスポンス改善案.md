# **チャンネル切り替え時のレスポンス改善案まとめ**

P2Pデスクトップ共有ソフトとDiscordクライアントを統合するプロジェクトにおいて、チャンネル切り替え時の「一瞬の遅延」はユーザー体験を大きく損ないます。レスポンス重視の設計に合わせるための4つの改善ポイントを提案します。

## **1\. 「黒いカーテン」の廃止と visibility 制御**

現在実装されている isSwitchingChannel による黒いオーバーレイは、ロードを視覚的に強調してしまいます。これを「非表示（隠す）」状態に置き換えることで、UIの連続性を保ちます。

* **現状:** isSwitchingChannel が true の間、画面全体（またはチャットエリア）を黒く塗りつぶしている。  
* **改善:** チャットエリアのみ visibility: hidden に設定する。  
  * メッセージのレンダリングやスクロール位置の計算は裏で行わせ、準備が整った瞬間に表示（visible）に切り替えます。  
  * サイドバーやヘッダーは見えたままなので、アプリが止まった感覚を排除できます。

## **2\. 同期的スクロール位置の確定 (useLayoutEffect)**

requestAnimationFrame を使用すると、ブラウザの次の描画フレームまで処理が遅延します。これを排除し、useLayoutEffect 内でDOMに直接値を書き込むことで、「表示された時にはすでに最下部にいる」状態を作ります。  
useLayoutEffect(() \=\> {  
    if (isSwitchingChannel) {  
        const container \= messagesContainerRef.current;  
        if (container && (messages.length \> 0 || \!isLoadingChannel)) {  
            // behavior: 'smooth' や 'instant' (scrollIntoView) よりも高速  
            // DOMに直接代入することで、このEffectを抜ける瞬間のPaintで正しい位置になる  
            container.scrollTop \= container.scrollHeight;  
              
            // 即座にフラグを落とす  
            setIsSwitchingChannel(false);  
        }  
    }  
}, \[messages, isSwitchingChannel, isLoadingChannel\]);

## **3\. レイアウトシフト（カクつき）の防止**

画像の高さが未確定だと、スクロール位置を計算した後に画像が読み込まれ、表示位置がズレる（ガクッとなる）原因になります。

* **対策:** Discord APIから取得した width と height を img タグの属性に必ず指定します。  
* **効果:** 画像の実データが届く前から「そのサイズの空白」が確保されるため、スクロール位置の計算が1回で確定します。

## **4\. インメモリ・キャッシュ・レイヤーの導入**

現在は毎回 SQLite (Rust側) に問い合わせていますが、これには IPC (Inter-Process Communication) のオーバーヘッドがあります。

* **案:** 直近で表示した5〜10チャンネル分のメッセージを React 側の State（または Zustand 等のストア）に保持する。  
* 挙動: 1\. メモリにあれば 0ms で表示。  
  2\. 同時に Rust 側に最新の差分がないか問い合わせる（バックグラウンド）。  
  3\. 差分があれば、表示を静かに更新する。

## **統合後の体感フロー**

1. **ユーザーがチャンネルをクリック**  
2. **システム**: isSwitchingChannel を true に（チャットエリアが隠れるがサイドバーはそのまま）。  
3. **システム**: メモリまたはDBからメッセージをセット。  
4. **React**: DOMを生成（ブラウザのメモリ内）。  
5. **Effect**: useLayoutEffect が走り、scrollTop をガツンと最下部に合わせ、isSwitchingChannel を false に。  
6. **ブラウザ**: レンダリング実行。  
7. **結果**: ユーザーには「クリックした瞬間に、最新のメッセージが並んでいる」ように見える。

これらはボイスチャット統合時の「チャンネル入室」といったアクションでも同様に、UIの即時応答性を支える基盤となります。