# **P2Cord アーキテクチャ再設計指針**

「P2Dの中にDiscordがある」という状態から、「共通のコミュニケーション基盤の上に各機能が載っている」状態へ移行します。

## **1\. 概念の抽象化：Discordチャンネルを「Room」へ**

Discordの「TextChannel」や「VoiceChannel」を、アプリ内では単なる **Room** というリソースとして扱います。

* **Roomの属性**:  
  * metadata: Discord APIから取得した名前、カテゴリ、参加者。  
  * p2p\_session: その部屋で現在進行中のデスクトップ共有やボイスチャットの状態（WebRTC PeerConnection）。  
  * chat: メッセージ履歴（既存のDiscord取得ロジック）。

## **2\. バックエンド（Rust）の構造整理**

discord.rs や p2d.rs を「サービス」として独立させ、それらを管理する「コントローラー」を導入します。  
src-tauri/src/  
├── services/  
│   ├── identity/        \# 認証・ユーザー情報 (Discord API)  
│   ├── social/          \# サーバー・チャンネル・メッセージ (Discord API/Gateway)  
│   └── media/           \# P2P共有・音声通信 (WebRTC/P2Dコア)  
├── store/               \# SQLite (キャッシュ)  
└── bridge/              \# Tauri Commands (Frontendとの接点)

## **3\. フロントエンドのステート管理の刷新**

App.tsx に全てのロジックを置くのをやめ、\*\*「現在の通信コンテキスト」\*\*を管理するストア（Zustand等）を導入します。

* **ActiveSessionStore**:  
  * currentRoomId: 現在見ている場所。  
  * activeMedia: 現在参加中のボイスチャット、または視聴中の画面共有ストリーム。  
  * peers: 同じ部屋にいる他のユーザーのP2P接続状態。

## **4\. ボイスチャット統合の戦略**

Discordのボイスチャンネルに入室した際、以下のフローを自動化します。

1. **Signaling**: DiscordのGatewayを通じて「ボイスチャンネル入室」を通知。  
2. **P2P Discovery**: 同じチャンネルにいるユーザー間で、独自のシグナリングサーバー（既に開発済みのもの）を介してWebRTCのOffer/Answerを交換。  
3. **Media Swap**: Discordの音声サーバーを使うのではなく、**P2Pで直接音声を送受信するモード**に切り替える（これが「軽量クライアント」の強みになります）。

## **5\. UIの再定義：P2P-First デザイン**

Discord本家のUIをなぞるのではなく、\*\*「今、誰と、何をしているか」\*\*を中央に置くレイアウトに変更します。

* **サイドバー**: Discordのサーバー/チャンネル一覧（情報源）。  
* **メインエリア**:  
  * 画面共有が行われていれば、ビデオプレイヤーを最優先表示。  
  * ボイスチャット中なら、参加者のアバターと音量メーターを動的に表示。  
  * チャットは「付随するもの」として右側または下部に配置。

## **リファクタリングの具体的ステップ**

1. **Service層の分離**: src-tauri/src/lib.rs に直接ロジックを書かず、各モジュールに責務を委譲する。  
2. **Unified Command**: invoke('get\_messages') ではなく invoke('join\_room') のような、複数の処理（メッセージ取得＋P2P接続準備）をまとめたコマンドを作成する。  
3. **ボイス統合**: WebRTCのオーディオトラックを useWebRTC フックに追加し、DiscordのチャンネルIDをP2PのルームIDとして再利用する。